<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Board - We Want Waste</title>
    <style>
        /* [Previous CSS - keeping it the same] */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        h1 { color: #333; margin-bottom: 10px; }
        .stats { font-size: 14px; color: #666; }
        .board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; }
        .column { min-width: 280px; max-width: 280px; background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 400px; }
        .column.drag-over { background: #e3f2fd; }
        .column h2 { font-size: 14px; text-transform: uppercase; color: #666; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .column.ideas h2 { border-color: #9e9e9e; }
        .column.writing h2 { border-color: #2196f3; }
        .column.review h2 { border-color: #ff9800; }
        .column.scheduled h2 { border-color: #9c27b0; }
        .column.published h2 { border-color: #4caf50; }
        .card { background: #fafafa; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: move; border-left: 3px solid #ddd; transition: all 0.2s; user-select: none; -webkit-user-select: none; touch-action: none; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card.dragging { opacity: 0.5; }
        .card.high-priority { border-left-color: #f44336; }
        .card.generating { border-left-color: #2196f3; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .card-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #333; }
        .card-meta { display: flex; gap: 10px; font-size: 11px; color: #888; flex-wrap: wrap; }
        .card-meta span { background: #eee; padding: 2px 8px; border-radius: 10px; }
        .card-meta .status-badge { background: #2196f3; color: white; font-weight: 600; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .error { text-align: center; padding: 40px; color: #f44336; background: #ffebee; border-radius: 8px; margin: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 20px; overflow-y: auto; }
        .modal.active { display: flex; align-items: flex-start; justify-content: center; padding-top: 40px; }
        .modal-content { background: #fff; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: #333; color: #fff; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .modal-header h2 { font-size: 18px; line-height: 1.4; }
        .close-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; line-height: 1; padding: 0; margin-left: 15px; flex-shrink: 0; }
        .modal-body { padding: 20px; }
        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .info-item { background: #f5f5f5; padding: 10px; border-radius: 8px; }
        .info-item label { display: block; font-size: 10px; color: #888; margin-bottom: 3px; text-transform: uppercase; font-weight: 600; }
        .info-item span { font-size: 13px; color: #333; }
        @media (max-width: 600px) { .info-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Content Board</h1>
        <div class="stats" id="stats">Loading...</div>
        <p style="margin-top:10px;font-size:13px;color:#666;">Drag cards to WRITING to queue content generation automatically</p>
    </div>
    
    <div class="board" id="board">
        <div class="loading">Loading content ideas...</div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Content Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                Loading...
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zppiksmyqnigiziqsigq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_4xGNFr6q9Fv-_4tg4SVYRw_0D4nnSGz';
        
        let allIdeas = [];
        let draggedCard = null;
        
        // Load content from call_insights
        async function loadContentIdeas() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/call_insights?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const calls = await response.json();
                
                // Extract content angles
                allIdeas = [];
                calls.forEach(call => {
                    try {
                        const angles = typeof call.content_angles === 'string' 
                            ? JSON.parse(call.content_angles)
                            : call.content_angles || [];
                        
                        angles.forEach((angle, idx) => {
                            const ideaId = `${call.call_id}-${idx}`;
                            const savedStatus = localStorage.getItem(`card-status-${ideaId}`) || 'ideas';
                            const savedContent = localStorage.getItem(`card-content-${ideaId}`);
                            
                            allIdeas.push({
                                id: ideaId,
                                call_id: call.call_id,
                                index: idx,
                                title: angle.hook || angle.topic_detail || 'Untitled',
                                format: angle.format || 'blog_post',
                                audience: angle.target_audience || 'unknown',
                                topic: angle.topic_category || 'other',
                                priority: call.priority_score || 5,
                                status: savedStatus,
                                generated_content: savedContent,
                                details: angle
                            });
                        });
                    } catch (e) {}
                });
                
                renderBoard();
                updateStats();
                startPolling();
                
            } catch (error) {
                document.getElementById('board').innerHTML = `
                    <div class="error">
                        <h2>‚ùå Error Loading Data</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderBoard() {
            const columns = {
                ideas: { title: 'üí° IDEAS', items: [] },
                writing: { title: '‚úçÔ∏è WRITING', items: [] },
                review: { title: 'üëÄ REVIEW', items: [] },
                scheduled: { title: 'üìÖ SCHEDULED', items: [] },
                published: { title: '‚úÖ PUBLISHED', items: [] }
            };

            allIdeas.forEach(idea => {
                const status = idea.status || 'ideas';
                if (columns[status]) columns[status].items.push(idea);
            });

            const boardHTML = Object.entries(columns).map(([key, col]) => `
                <div class="column ${key}" data-column="${key}">
                    <h2>${col.title} (${col.items.length})</h2>
                    ${col.items.map(item => {
                        const isGenerating = item.status === 'writing' && !item.generated_content;
                        const topicPreview = item.details.topic_detail 
                            ? item.details.topic_detail.substring(0, 80) + (item.details.topic_detail.length > 80 ? '...' : '')
                            : '';
                        return `
                        <div class="card ${item.priority >= 7 ? 'high-priority' : ''} ${isGenerating ? 'generating' : ''}" 
                             data-id="${item.id}" 
                             draggable="true">
                            <div class="card-title">${item.title}</div>
                            ${topicPreview ? `<div style="font-size:12px;color:#666;margin:8px 0;line-height:1.4;">${topicPreview}</div>` : ''}
                            <div class="card-meta">
                                <span>${item.format.replace(/_/g, ' ')}</span>
                                <span>${item.audience}</span>
                                <span>P${item.priority}</span>
                                ${isGenerating ? '<span class="status-badge">Generating...</span>' : ''}
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `).join('');

            document.getElementById('board').innerHTML = boardHTML;
            initDragAndDrop();
        }

        function initDragAndDrop() {
            const cards = document.querySelectorAll('.card');
            const columns = document.querySelectorAll('.column');
            let touchStartY = 0;
            let touchStartX = 0;
            let touchMoved = false;

            cards.forEach(card => {
                // Desktop click to open
                card.addEventListener('click', e => {
                    if (!draggedCard) { // Only open if not dragging
                        openCard(card.dataset.id);
                    }
                });

                // Mouse events (desktop drag)
                card.addEventListener('dragstart', e => {
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    draggedCard = null;
                });

                // Touch events (mobile)
                card.addEventListener('touchstart', e => {
                    touchStartY = e.touches[0].clientY;
                    touchStartX = e.touches[0].clientX;
                    touchMoved = false;
                    draggedCard = card;
                    
                    // Delay adding dragging class to distinguish tap from drag
                    setTimeout(() => {
                        if (draggedCard === card) {
                            card.classList.add('dragging');
                        }
                    }, 150);
                }, { passive: true });

                card.addEventListener('touchmove', e => {
                    if (!draggedCard) return;
                    
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - touchStartX);
                    const deltaY = Math.abs(touch.clientY - touchStartY);
                    
                    // If moved more than 10px, it's a drag
                    if (deltaX > 10 || deltaY > 10) {
                        touchMoved = true;
                        card.classList.add('dragging');
                        
                        const elementAtPoint = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetColumn = elementAtPoint?.closest('.column');
                        
                        // Remove drag-over from all columns
                        columns.forEach(col => col.classList.remove('drag-over'));
                        
                        // Add to current column
                        if (targetColumn) {
                            targetColumn.classList.add('drag-over');
                        }
                    }
                }, { passive: true });

                card.addEventListener('touchend', e => {
                    if (!draggedCard) return;
                    
                    const touch = e.changedTouches[0];
                    const deltaX = Math.abs(touch.clientX - touchStartX);
                    const deltaY = Math.abs(touch.clientY - touchStartY);
                    
                    // If didn't move much (< 10px), it's a tap - open the card
                    if (!touchMoved && deltaX < 10 && deltaY < 10) {
                        openCard(card.dataset.id);
                    } else {
                        // It's a drag - process the move
                        const elementAtPoint = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetColumn = elementAtPoint?.closest('.column');
                        
                        if (targetColumn && draggedCard) {
                            const cardId = draggedCard.dataset.id;
                            const newStatus = targetColumn.dataset.column;
                            
                            const idea = allIdeas.find(i => i.id === cardId);
                            if (idea) {
                                idea.status = newStatus;
                                localStorage.setItem(`card-status-${cardId}`, newStatus);
                                
                                // Notify backend if moved to "writing"
                                if (newStatus === 'writing' && !idea.generated_content) {
                                    notifyContentGeneration(idea);
                                }
                                
                                renderBoard();
                            }
                        }
                    }
                    
                    // Cleanup
                    card.classList.remove('dragging');
                    columns.forEach(col => col.classList.remove('drag-over'));
                    draggedCard = null;
                    touchMoved = false;
                }, { passive: true });
            });

            // Mouse events for columns (desktop)
            columns.forEach(column => {
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });

                column.addEventListener('drop', e => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    if (draggedCard) {
                        const cardId = draggedCard.dataset.id;
                        const newStatus = column.dataset.column;
                        
                        const idea = allIdeas.find(i => i.id === cardId);
                        if (idea) {
                            idea.status = newStatus;
                            localStorage.setItem(`card-status-${cardId}`, newStatus);
                            
                            // Notify backend if moved to "writing"
                            if (newStatus === 'writing' && !idea.generated_content) {
                                notifyContentGeneration(idea);
                            }
                            
                            renderBoard();
                        }
                    }
                });
            });
        }

        async function notifyContentGeneration(idea) {
            // Write generation request to Supabase
            const request = {
                card_id: idea.id,
                call_id: idea.call_id,
                title: idea.title,
                format: idea.format,
                topic_detail: idea.details.topic_detail,
                hook: idea.details.hook,
                target_audience: idea.audience,
                priority_score: idea.priority,
                status: 'pending'
            };
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/content_generation_queue`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(request)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Content generation queued:', idea.title);
                    // Show brief confirmation
                    const msg = document.createElement('div');
                    msg.textContent = '‚úÖ Content queued for generation';
                    msg.style.cssText = 'position:fixed;top:20px;right:20px;background:#4caf50;color:white;padding:15px 20px;border-radius:8px;z-index:9999;font-weight:600;';
                    document.body.appendChild(msg);
                    setTimeout(() => msg.remove(), 3000);
                } else {
                    console.error('‚ùå Failed to queue:', await response.text());
                    alert('‚ùå Failed to queue content. Check console for details.');
                }
            } catch (error) {
                console.error('‚ùå Error queuing:', error);
                alert('‚ùå Error queuing content: ' + error.message);
            }
        }

        function startPolling() {
            // Check for generation requests every 30 seconds
            setInterval(checkGenerationRequests, 30000);
            checkGenerationRequests(); // Check immediately
        }

        async function checkGenerationRequests() {
            // Check status for all cards in "writing" state
            const writingCards = allIdeas.filter(i => i.status === 'writing' && !i.generated_content);
            
            for (const card of writingCards) {
                try {
                    const response = await fetch(`http://localhost:18791/status/${card.id}`);
                    const data = await response.json();
                    
                    if (data.status === 'complete' && data.content) {
                        console.log(`‚úÖ Content generated for: ${card.title}`);
                        card.generated_content = data.content;
                        card.status = 'review';
                        localStorage.setItem(`card-status-${card.id}`, 'review');
                        localStorage.setItem(`card-content-${card.id}`, data.content);
                    }
                } catch (error) {
                    // Queue server might not be running or content not ready yet
                }
            }
            
            if (writingCards.length > 0) {
                renderBoard();
            }
        }

        function updateStats() {
            const total = allIdeas.length;
            const writing = allIdeas.filter(i => i.status === 'writing').length;
            const review = allIdeas.filter(i => i.status === 'review').length;
            
            document.getElementById('stats').textContent = 
                `${total} content ideas ‚Ä¢ ${writing} in progress ‚Ä¢ ${review} awaiting review`;
        }

        async function triggerContentGeneration() {
            const writingCards = allIdeas.filter(i => i.status === 'writing' && !i.generated_content);
            
            if (writingCards.length === 0) {
                alert('No cards in Writing queue');
                return;
            }
            
            // Create simple text summary for WhatsApp
            const message = `Generate AEO content for ${writingCards.length} card(s):\n\n` +
                writingCards.map((card, idx) => 
                    `${idx + 1}. ${card.title}\n   Format: ${card.format}\n   Audience: ${card.audience}\n   ID: ${card.id}`
                ).join('\n\n');
            
            // Copy to clipboard
            try {
                await navigator.clipboard.writeText(message);
                alert(`‚úÖ Copied ${writingCards.length} content request(s) to clipboard!\n\nPaste in WhatsApp to send to Curl.`);
            } catch (e) {
                // Fallback: show text to copy manually
                const textarea = document.createElement('textarea');
                textarea.value = message;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert(`‚úÖ Copied to clipboard! Paste in WhatsApp.`);
            }
        }

        function openCard(id) {
            const idea = allIdeas.find(i => i.id === id);
            if (!idea) return;

            document.getElementById('modalTitle').textContent = idea.title;
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom:20px;padding:15px;background:#f5f5f5;border-radius:8px;">
                    <label style="display:block;font-size:12px;text-transform:uppercase;color:#888;margin-bottom:8px;font-weight:600;">Move to Column</label>
                    <select id="statusSelect" onchange="changeCardStatus('${idea.id}')" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;background:white;cursor:pointer;">
                        <option value="ideas" ${idea.status === 'ideas' ? 'selected' : ''}>üí° IDEAS</option>
                        <option value="writing" ${idea.status === 'writing' ? 'selected' : ''}>‚úçÔ∏è WRITING</option>
                        <option value="review" ${idea.status === 'review' ? 'selected' : ''}>üëÄ REVIEW</option>
                        <option value="scheduled" ${idea.status === 'scheduled' ? 'selected' : ''}>üìÖ SCHEDULED</option>
                        <option value="published" ${idea.status === 'published' ? 'selected' : ''}>‚úÖ PUBLISHED</option>
                    </select>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <label>Format</label>
                        <span>${idea.format.replace(/_/g, ' ')}</span>
                    </div>
                    <div class="info-item">
                        <label>Audience</label>
                        <span>${idea.audience}</span>
                    </div>
                    <div class="info-item">
                        <label>Priority</label>
                        <span>${idea.priority}/10</span>
                    </div>
                    <div class="info-item">
                        <label>Topic</label>
                        <span>${idea.topic.replace(/_/g, ' ')}</span>
                    </div>
                    <div class="info-item">
                        <label>Call ID</label>
                        <span>${idea.call_id.substring(0, 20)}...</span>
                    </div>
                    <div class="info-item">
                        <label>Index</label>
                        <span>${idea.index}</span>
                    </div>
                </div>
                
                <div style="margin-top:20px;">
                    <h3 style="font-size:12px;text-transform:uppercase;color:#888;margin-bottom:10px;">Hook</h3>
                    <div style="background:#f5f5f5;padding:15px;border-radius:8px;line-height:1.6;">
                        ${idea.details.hook || 'No hook available'}
                    </div>
                </div>
                
                ${idea.details.topic_detail ? `
                    <div style="margin-top:20px;">
                        <h3 style="font-size:12px;text-transform:uppercase;color:#888;margin-bottom:10px;">Topic Detail</h3>
                        <div style="background:#f5f5f5;padding:15px;border-radius:8px;line-height:1.6;">
                            ${idea.details.topic_detail}
                        </div>
                    </div>
                ` : ''}
                
                ${idea.generated_content ? `
                    <div style="margin-top:20px;">
                        <h3 style="font-size:12px;text-transform:uppercase;color:#888;margin-bottom:10px;">Generated Content</h3>
                        <div style="background:#e8f5e9;padding:15px;border-radius:8px;line-height:1.6;max-height:400px;overflow-y:auto;">
                            <pre style="white-space:pre-wrap;font-family:inherit;margin:0;">${idea.generated_content}</pre>
                        </div>
                    </div>
                ` : ''}
            `;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function changeCardStatus(cardId) {
            const newStatus = document.getElementById('statusSelect').value;
            const idea = allIdeas.find(i => i.id === cardId);
            
            if (idea) {
                idea.status = newStatus;
                localStorage.setItem(`card-status-${cardId}`, newStatus);
                
                // Notify backend if moved to "writing"
                if (newStatus === 'writing' && !idea.generated_content) {
                    notifyContentGeneration(idea);
                }
                
                closeModal();
                renderBoard();
                
                // Show confirmation
                const statusNames = {
                    'ideas': 'üí° IDEAS',
                    'writing': '‚úçÔ∏è WRITING',
                    'review': 'üëÄ REVIEW',
                    'scheduled': 'üìÖ SCHEDULED',
                    'published': '‚úÖ PUBLISHED'
                };
                
                alert(`‚úÖ Moved to ${statusNames[newStatus]}`);
            }
        }

        // Close modal when clicking outside
        document.getElementById('modal').addEventListener('click', e => {
            if (e.target.id === 'modal') closeModal();
        });

        loadContentIdeas();
    </script>
</body>
</html>

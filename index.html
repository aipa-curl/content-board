<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Board - We Want Waste</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        h1 { color: #333; margin-bottom: 10px; }
        .stats { font-size: 14px; color: #666; }
        .board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; }
        .column { min-width: 280px; max-width: 280px; background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 400px; }
        .column.drag-over { background: #e3f2fd; }
        .column h2 { font-size: 14px; text-transform: uppercase; color: #666; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .column.ideas h2 { border-color: #9e9e9e; }
        .column.writing h2 { border-color: #2196f3; }
        .column.review h2 { border-color: #ff9800; }
        .column.scheduled h2 { border-color: #9c27b0; }
        .column.published h2 { border-color: #4caf50; }
        .card { background: #fafafa; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: move; border-left: 3px solid #ddd; transition: all 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card.dragging { opacity: 0.5; }
        .card.high-priority { border-left-color: #f44336; }
        .card-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #333; }
        .card-meta { display: flex; gap: 10px; font-size: 11px; color: #888; flex-wrap: wrap; }
        .card-meta span { background: #eee; padding: 2px 8px; border-radius: 10px; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .error { text-align: center; padding: 40px; color: #f44336; background: #ffebee; border-radius: 8px; margin: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 20px; overflow-y: auto; }
        .modal.active { display: flex; align-items: flex-start; justify-content: center; padding-top: 40px; }
        .modal-content { background: #fff; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: #333; color: #fff; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .modal-header h2 { font-size: 18px; line-height: 1.4; }
        .close-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; line-height: 1; padding: 0; margin-left: 15px; flex-shrink: 0; }
        .modal-body { padding: 20px; }
        .section { margin-bottom: 20px; }
        .section h3 { font-size: 12px; text-transform: uppercase; color: #888; margin-bottom: 10px; font-weight: 600; }
        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .info-item { background: #f5f5f5; padding: 10px; border-radius: 8px; }
        .info-item label { display: block; font-size: 10px; color: #888; margin-bottom: 3px; text-transform: uppercase; font-weight: 600; }
        .info-item span { font-size: 13px; color: #333; }
        .quote-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; font-style: italic; color: #333; margin-bottom: 15px; }
        .context-box { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; border-radius: 8px; color: #333; margin-bottom: 15px; line-height: 1.6; }
        .pain-box { background: #ffebee; border-left: 4px solid #f44336; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .pain-box strong { color: #c62828; display: block; margin-bottom: 8px; }
        .insight-box { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .insight-box strong { color: #2e7d32; display: block; margin-bottom: 8px; }
        @media (max-width: 600px) {
            .board { gap: 10px; }
            .column { min-width: 250px; max-width: 250px; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Content Board</h1>
        <div class="stats" id="stats">Loading...</div>
    </div>
    <div class="board" id="board">
        <div class="loading">Loading content ideas from call insights...</div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Card Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zppiksmyqnigiziqsigq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_4xGNFr6q9Fv-_4tg4SVYRw_0D4nnSGz';
        
        let allIdeas = [];
        let callData = {};
        let draggedCard = null;

        async function loadContentIdeas() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/call_insights?select=call_id,content_angles,sentiment,priority_score,call_date,pain_points,product_insights,transcript_text,from_number,customer_segment,outcome&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                // Store full call data for reference
                data.forEach(call => {
                    callData[call.call_id] = call;
                });
                
                // Extract content angles with full context
                const contentIdeas = [];
                data.forEach(call => {
                    let angles = [];
                    try {
                        angles = typeof call.content_angles === 'string' 
                            ? JSON.parse(call.content_angles) 
                            : call.content_angles || [];
                    } catch (e) {
                        angles = [];
                    }

                    angles.forEach((angle, idx) => {
                        contentIdeas.push({
                            id: `${call.call_id}-${idx}`,
                            call_id: call.call_id,
                            title: angle.hook || angle.topic_detail || 'Untitled',
                            format: angle.format || 'blog_post',
                            audience: angle.target_audience || 'general',
                            topic: angle.topic_category || 'other',
                            sentiment: call.sentiment || 'neutral',
                            priority: call.priority_score || 5,
                            status: localStorage.getItem(`card-status-${call.call_id}-${idx}`) || 'ideas',
                            call_date: call.call_date,
                            details: angle
                        });
                    });
                });

                if (contentIdeas.length === 0) {
                    document.getElementById('board').innerHTML = `
                        <div class="error">
                            <h2>‚ö†Ô∏è No Content Ideas Found</h2>
                            <p>No content_angles in database yet.</p>
                        </div>
                    `;
                    return;
                }
                
                allIdeas = contentIdeas;
                renderBoard();
                updateStats();
                
            } catch (error) {
                document.getElementById('board').innerHTML = `
                    <div class="error">
                        <h2>‚ùå Error Loading Data</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderBoard() {
            const columns = {
                ideas: { title: 'üí° IDEAS', items: [] },
                writing: { title: '‚úçÔ∏è WRITING', items: [] },
                review: { title: 'üëÄ REVIEW', items: [] },
                scheduled: { title: 'üìÖ SCHEDULED', items: [] },
                published: { title: '‚úÖ PUBLISHED', items: [] }
            };

            allIdeas.forEach(idea => {
                const status = idea.status || 'ideas';
                if (columns[status]) columns[status].items.push(idea);
            });

            const boardHTML = Object.entries(columns).map(([key, col]) => `
                <div class="column ${key}" data-column="${key}">
                    <h2>${col.title} (${col.items.length})</h2>
                    ${col.items.map(item => `
                        <div class="card ${item.priority >= 7 ? 'high-priority' : ''}" 
                             data-id="${item.id}" 
                             draggable="true"
                             onclick="openCard('${item.id}')">
                            <div class="card-title">${item.title}</div>
                            <div class="card-meta">
                                <span>${item.format}</span>
                                <span>${item.audience}</span>
                                ${item.priority >= 7 ? '<span style="background:#ffebee;color:#c62828">high</span>' : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');

            document.getElementById('board').innerHTML = boardHTML;
            initDragAndDrop();
        }

        function initDragAndDrop() {
            const cards = document.querySelectorAll('.card');
            const columns = document.querySelectorAll('.column');

            cards.forEach(card => {
                card.addEventListener('dragstart', e => {
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    draggedCard = null;
                });
            });

            columns.forEach(column => {
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });

                column.addEventListener('drop', e => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    if (draggedCard) {
                        const cardId = draggedCard.dataset.id;
                        const newStatus = column.dataset.column;
                        
                        const idea = allIdeas.find(i => i.id === cardId);
                        if (idea) {
                            idea.status = newStatus;
                            localStorage.setItem(`card-status-${cardId}`, newStatus);
                            renderBoard();
                        }
                    }
                });
            });
        }

        function openCard(id) {
            const idea = allIdeas.find(i => i.id === id);
            if (!idea) return;

            const call = callData[idea.call_id];
            
            // Parse pain points and product insights
            let painPoints = [];
            let productInsights = [];
            try {
                painPoints = typeof call.pain_points === 'string' 
                    ? JSON.parse(call.pain_points) 
                    : call.pain_points || [];
                productInsights = typeof call.product_insights === 'string'
                    ? JSON.parse(call.product_insights)
                    : call.product_insights || [];
            } catch (e) {}

            // Get relevant pain point (if it matches the topic)
            const relevantPain = painPoints.find(p => 
                p.category === idea.topic || 
                p.description?.toLowerCase().includes(idea.topic)
            ) || painPoints[0];

            // Get relevant insight
            const relevantInsight = productInsights.find(i =>
                i.category === idea.topic ||
                i.insight?.toLowerCase().includes(idea.topic)
            ) || productInsights[0];

            // Transcript preview (first 400 chars)
            const transcriptPreview = call.transcript_text 
                ? call.transcript_text.substring(0, 400) + (call.transcript_text.length > 400 ? '...' : '')
                : 'No transcript available';

            document.getElementById('modalTitle').textContent = idea.title;
            document.getElementById('modalBody').innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <label>Format</label>
                        <span>${idea.format}</span>
                    </div>
                    <div class="info-item">
                        <label>Audience</label>
                        <span>${idea.audience}</span>
                    </div>
                    <div class="info-item">
                        <label>Topic</label>
                        <span>${idea.topic}</span>
                    </div>
                    <div class="info-item">
                        <label>Priority</label>
                        <span>${idea.priority}/10</span>
                    </div>
                    <div class="info-item">
                        <label>Customer Segment</label>
                        <span>${call.customer_segment || 'unknown'}</span>
                    </div>
                    <div class="info-item">
                        <label>Call Outcome</label>
                        <span>${call.outcome || 'unknown'}</span>
                    </div>
                </div>

                ${relevantPain && relevantPain.direct_quote ? `
                    <div class="section">
                        <h3>üí¨ Customer Quote</h3>
                        <div class="quote-box">
                            "${relevantPain.direct_quote}"
                        </div>
                    </div>
                ` : ''}

                ${relevantPain ? `
                    <div class="section">
                        <h3>üò§ Customer Pain Point</h3>
                        <div class="pain-box">
                            <strong>${relevantPain.category.replace(/_/g, ' ')} (${relevantPain.severity})</strong>
                            ${relevantPain.description}
                        </div>
                    </div>
                ` : ''}

                ${idea.details?.topic_detail ? `
                    <div class="section">
                        <h3>üìù Content Angle</h3>
                        <div class="context-box">
                            ${idea.details.topic_detail}
                        </div>
                    </div>
                ` : ''}

                ${relevantInsight ? `
                    <div class="section">
                        <h3>üí° Business Insight</h3>
                        <div class="insight-box">
                            <strong>${relevantInsight.category?.replace(/_/g, ' ')} (${relevantInsight.impact} impact)</strong>
                            ${relevantInsight.insight}
                        </div>
                    </div>
                ` : ''}

                <div class="section">
                    <h3>üìû Call Context</h3>
                    <div class="context-box">
                        ${transcriptPreview}
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function updateStats() {
            const total = allIdeas.length;
            const highPriority = allIdeas.filter(i => i.priority >= 7).length;
            const formats = [...new Set(allIdeas.map(i => i.format))].length;
            document.getElementById('stats').textContent = 
                `${total} content ideas ‚Ä¢ ${highPriority} high priority ‚Ä¢ ${formats} formats`;
        }

        document.getElementById('modal').addEventListener('click', e => {
            if (e.target.id === 'modal') closeModal();
        });

        loadContentIdeas();
    </script>
</body>
</html>

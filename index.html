<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Board - We Want Waste</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        h1 { color: #333; margin-bottom: 10px; }
        .stats { font-size: 14px; color: #666; }
        .board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; }
        .column { min-width: 280px; max-width: 280px; background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .column h2 { font-size: 14px; text-transform: uppercase; color: #666; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .column.ideas h2 { border-color: #9e9e9e; }
        .column.writing h2 { border-color: #2196f3; }
        .column.review h2 { border-color: #ff9800; }
        .column.scheduled h2 { border-color: #9c27b0; }
        .column.published h2 { border-color: #4caf50; }
        .card { background: #fafafa; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; border-left: 3px solid #ddd; transition: all 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card.high-priority { border-left-color: #f44336; }
        .card-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #333; }
        .card-meta { display: flex; gap: 10px; font-size: 11px; color: #888; flex-wrap: wrap; }
        .card-meta span { background: #eee; padding: 2px 8px; border-radius: 10px; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .error { text-align: center; padding: 40px; color: #f44336; background: #ffebee; border-radius: 8px; margin: 20px; }
        @media (max-width: 600px) {
            .board { gap: 10px; }
            .column { min-width: 250px; max-width: 250px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Content Board</h1>
        <div class="stats" id="stats">Loading...</div>
    </div>
    <div class="board" id="board">
        <div class="loading">Loading content ideas from call insights...</div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zppiksmyqnigiziqsigq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_4xGNFr6q9Fv-_4tg4SVYRw_0D4nnSGz';
        
        async function loadContentIdeas() {
            try {
                console.log('Fetching call insights...');
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/call_insights?select=call_id,content_angles,sentiment,priority_score,call_date&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`Fetched ${data.length} call insights`);
                
                // Extract and flatten content angles
                const contentIdeas = [];
                data.forEach(call => {
                    let angles = [];
                    try {
                        if (typeof call.content_angles === 'string') {
                            angles = JSON.parse(call.content_angles);
                        } else {
                            angles = call.content_angles || [];
                        }
                    } catch (e) {
                        console.warn('Failed to parse content_angles for call', call.call_id, e);
                        angles = [];
                    }

                    angles.forEach((angle, idx) => {
                        contentIdeas.push({
                            id: `${call.call_id}-${idx}`,
                            title: angle.hook || angle.topic_detail || 'Untitled',
                            format: angle.format || 'blog_post',
                            audience: angle.target_audience || 'general',
                            topic: angle.topic_category || angle.topic_detail || 'other',
                            sentiment: call.sentiment || 'neutral',
                            priority: call.priority_score || 5,
                            status: 'ideas',
                            call_date: call.call_date
                        });
                    });
                });

                console.log(`Extracted ${contentIdeas.length} content ideas`);
                
                if (contentIdeas.length === 0) {
                    document.getElementById('board').innerHTML = `
                        <div class="error">
                            <h2>‚ö†Ô∏è No Content Ideas Found</h2>
                            <p>The database has ${data.length} call insights but no content_angles extracted.</p>
                        </div>
                    `;
                    return;
                }
                
                renderBoard(contentIdeas);
                updateStats(contentIdeas);
                
            } catch (error) {
                console.error('Error loading content:', error);
                document.getElementById('board').innerHTML = `
                    <div class="error">
                        <h2>‚ùå Error Loading Data</h2>
                        <p>${error.message}</p>
                        <p style="margin-top:10px; font-size:12px;">Check browser console for details</p>
                    </div>
                `;
            }
        }

        function renderBoard(ideas) {
            const columns = {
                ideas: { title: 'üí° IDEAS', items: [] },
                writing: { title: '‚úçÔ∏è WRITING', items: [] },
                review: { title: 'üëÄ REVIEW', items: [] },
                scheduled: { title: 'üìÖ SCHEDULED', items: [] },
                published: { title: '‚úÖ PUBLISHED', items: [] }
            };

            // Group by status (all default to ideas for now)
            ideas.forEach(idea => {
                const status = idea.status || 'ideas';
                if (columns[status]) {
                    columns[status].items.push(idea);
                }
            });

            const boardHTML = Object.entries(columns).map(([key, col]) => `
                <div class="column ${key}">
                    <h2>${col.title} (${col.items.length})</h2>
                    ${col.items.map(item => `
                        <div class="card ${item.priority >= 7 ? 'high-priority' : ''}">
                            <div class="card-title">${item.title}</div>
                            <div class="card-meta">
                                <span>${item.format}</span>
                                <span>${item.audience}</span>
                                ${item.priority >= 7 ? '<span style="background:#ffebee;color:#c62828">high</span>' : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');

            document.getElementById('board').innerHTML = boardHTML;
        }

        function updateStats(ideas) {
            const total = ideas.length;
            const highPriority = ideas.filter(i => i.priority >= 7).length;
            const formats = [...new Set(ideas.map(i => i.format))].length;
            
            document.getElementById('stats').textContent = 
                `${total} content ideas ‚Ä¢ ${highPriority} high priority ‚Ä¢ ${formats} formats`;
        }

        // Initialize
        loadContentIdeas();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Board - We Want Waste</title>
    <style>
        /* [Previous CSS - keeping it the same] */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        h1 { color: #333; margin-bottom: 10px; }
        .stats { font-size: 14px; color: #666; }
        .board { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; }
        .column { min-width: 280px; max-width: 280px; background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 400px; }
        .column.drag-over { background: #e3f2fd; }
        .column h2 { font-size: 14px; text-transform: uppercase; color: #666; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .column.ideas h2 { border-color: #9e9e9e; }
        .column.writing h2 { border-color: #2196f3; }
        .column.review h2 { border-color: #ff9800; }
        .column.scheduled h2 { border-color: #9c27b0; }
        .column.published h2 { border-color: #4caf50; }
        .card { background: #fafafa; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; border-left: 3px solid #ddd; transition: all 0.2s; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #fff; }
        .card.dragging { opacity: 0.5; }
        .card.high-priority { border-left-color: #f44336; }
        .card.generating { border-left-color: #2196f3; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .card-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #333; }
        .card-meta { display: flex; gap: 10px; font-size: 11px; color: #888; flex-wrap: wrap; }
        .card-meta span { background: #eee; padding: 2px 8px; border-radius: 10px; }
        .card-meta .status-badge { background: #2196f3; color: white; font-weight: 600; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .error { text-align: center; padding: 40px; color: #f44336; background: #ffebee; border-radius: 8px; margin: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 20px; overflow-y: auto; }
        .modal.active { display: flex; align-items: flex-start; justify-content: center; padding-top: 40px; }
        .modal-content { background: #fff; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: #333; color: #fff; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .modal-header h2 { font-size: 18px; line-height: 1.4; }
        .close-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; line-height: 1; padding: 0; margin-left: 15px; }
        .modal-body { padding: 20px; }
        .detail-section { margin-bottom: 20px; }
        .detail-label { font-size: 12px; text-transform: uppercase; color: #888; font-weight: 600; margin-bottom: 5px; }
        .detail-value { font-size: 14px; color: #333; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Content Board</h1>
        <div class="stats" id="stats">Loading...</div>
        <button onclick="location.reload(true)" style="margin-top:10px;padding:8px 15px;background:#4caf50;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
            üîÑ Refresh from Database
        </button>
    </div>
    
    <div class="board" id="board">
        <div class="loading">Loading content ideas...</div>
    </div>

    <div class="modal" id="modal" onclick="if(event.target.id==='modal') closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Content Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                Loading...
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zppiksmyqnigiziqsigq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_4xGNFr6q9Fv-_4tg4SVYRw_0D4nnSGz';
        
        let allIdeas = [];
        let draggedCard = null;
        
        // Load content from call_insights
        async function loadContentIdeas() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/call_insights?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const calls = await response.json();
                
                // Fetch generated content from queue
                const queueResponse = await fetch(`${SUPABASE_URL}/rest/v1/content_generation_queue?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                const queueData = await queueResponse.json();
                const generatedContent = {};
                queueData.forEach(item => {
                    if (item.generated_content) {
                        generatedContent[item.card_id] = item.generated_content;
                    }
                });
                
                // Extract content angles
                allIdeas = [];
                calls.forEach(call => {
                    try {
                        // Parse all data from call
                        const angles = typeof call.content_angles === 'string' 
                            ? JSON.parse(call.content_angles)
                            : call.content_angles || [];
                        const painPoints = typeof call.pain_points === 'string' 
                            ? JSON.parse(call.pain_points) 
                            : call.pain_points || [];
                        const productInsights = typeof call.product_insights === 'string'
                            ? JSON.parse(call.product_insights)
                            : call.product_insights || [];
                        
                        // Create one card per pain point
                        if (painPoints.length > 0) {
                            painPoints.forEach((painPoint, idx) => {
                                const ideaId = `${call.call_id}-pain-${idx}`;
                                const hasGeneratedContent = generatedContent[ideaId];
                                const content = hasGeneratedContent || localStorage.getItem(`card-content-${ideaId}`);
                                
                                // Determine status: if content exists, force to review
                                let savedStatus;
                                if (hasGeneratedContent) {
                                    savedStatus = 'review';
                                    localStorage.setItem(`card-status-${ideaId}`, 'review');
                                } else {
                                    savedStatus = localStorage.getItem(`card-status-${ideaId}`) || 'ideas';
                                }
                                
                                // Find matching content angle and insight for this pain point
                                const relatedAngle = angles[idx] || angles[0] || {};
                                const relatedInsight = productInsights[idx] || productInsights[0] || null;
                                
                                // Generate card number (sequential)
                                const cardNumber = allIdeas.length + 1;
                                
                                allIdeas.push({
                                    id: ideaId,
                                    cardNumber: cardNumber,
                                    call_id: call.call_id,
                                    index: idx,
                                    title: painPoint.description || 'Customer pain point',
                                    format: relatedAngle.format || 'blog_post',
                                    audience: relatedAngle.target_audience || 'unknown',
                                    topic: painPoint.category || 'other',
                                    priority: call.priority_score || 5,
                                    status: savedStatus,
                                    generated_content: content,
                                    details: relatedAngle,
                                    painPoint: painPoint,
                                    insight: relatedInsight,
                                    sentiment: call.sentiment,
                                    outcome: call.outcome,
                                    customerQuote: painPoint.direct_quote || ''
                                });
                            });
                        }
                    } catch (e) {}
                });
                
                renderBoard();
                updateStats();
                startPolling();
                
            } catch (error) {
                document.getElementById('board').innerHTML = `
                    <div class="error">
                        <h2>‚ùå Error Loading Data</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderBoard() {
            const columns = {
                ideas: { title: 'üí° IDEAS', items: [] },
                writing: { title: '‚úçÔ∏è WRITING', items: [] },
                review: { title: 'üëÄ REVIEW', items: [] },
                scheduled: { title: 'üìÖ SCHEDULED', items: [] },
                published: { title: '‚úÖ PUBLISHED', items: [] }
            };

            allIdeas.forEach(idea => {
                const status = idea.status || 'ideas';
                if (columns[status]) columns[status].items.push(idea);
            });

            const boardHTML = Object.entries(columns).map(([key, col]) => `
                <div class="column ${key}" data-column="${key}">
                    <h2>${col.title} (${col.items.length})</h2>
                    ${col.items.map(item => {
                        const isGenerating = item.status === 'writing' && !item.generated_content;
                        return `
                        <div class="card ${item.priority >= 7 ? 'high-priority' : ''} ${isGenerating ? 'generating' : ''}" 
                             data-id="${item.id}" 
                             onclick="openCard('${item.id}')">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px;">
                                <div class="card-title" style="flex:1;">${item.title}</div>
                                <div style="background:#2196f3;color:white;padding:4px 10px;border-radius:12px;font-weight:700;font-size:12px;margin-left:10px;">
                                    #${item.cardNumber}
                                </div>
                            </div>
                            <div class="card-meta">
                                <span>${item.format}</span>
                                <span>${item.audience}</span>
                                <span>P${item.priority}</span>
                                ${isGenerating ? '<span class="status-badge">Generating...</span>' : ''}
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `).join('');

            document.getElementById('board').innerHTML = boardHTML;
            initDragAndDrop();
        }

        function initDragAndDrop() {
            const cards = document.querySelectorAll('.card');
            const columns = document.querySelectorAll('.column');

            cards.forEach(card => {
                card.addEventListener('dragstart', e => {
                    draggedCard = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    draggedCard = null;
                });
            });

            columns.forEach(column => {
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    column.classList.add('drag-over');
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });

                column.addEventListener('drop', e => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    if (draggedCard) {
                        const cardId = draggedCard.dataset.id;
                        const newStatus = column.dataset.column;
                        
                        const idea = allIdeas.find(i => i.id === cardId);
                        if (idea) {
                            idea.status = newStatus;
                            localStorage.setItem(`card-status-${cardId}`, newStatus);
                            
                            // Notify backend if moved to "writing"
                            if (newStatus === 'writing' && !idea.generated_content) {
                                notifyContentGeneration(idea);
                            }
                            
                            renderBoard();
                        }
                    }
                });
            });
        }

        async function notifyContentGeneration(idea) {
            // POST to queue server
            const request = {
                id: idea.id,
                call_id: idea.call_id,
                title: idea.title,
                format: idea.format,
                topic_detail: idea.details.topic_detail,
                hook: idea.details.hook,
                target_audience: idea.audience,
                priority_score: idea.priority,
                requested_at: Date.now()
            };
            
            try {
                const response = await fetch('http://localhost:18791/queue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(request)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Generation request queued:', idea.id);
                } else {
                    console.error('‚ùå Failed to queue request:', await response.text());
                }
            } catch (error) {
                console.error('‚ùå Error queuing request:', error);
            }
        }

        function startPolling() {
            // Check for generation requests every 30 seconds
            setInterval(checkGenerationRequests, 30000);
            checkGenerationRequests(); // Check immediately
        }

        async function checkGenerationRequests() {
            // Check status for all cards in "writing" state
            const writingCards = allIdeas.filter(i => i.status === 'writing' && !i.generated_content);
            
            for (const card of writingCards) {
                try {
                    const response = await fetch(`http://localhost:18791/status/${card.id}`);
                    const data = await response.json();
                    
                    if (data.status === 'complete' && data.content) {
                        console.log(`‚úÖ Content generated for: ${card.title}`);
                        card.generated_content = data.content;
                        card.status = 'review';
                        localStorage.setItem(`card-status-${card.id}`, 'review');
                        localStorage.setItem(`card-content-${card.id}`, data.content);
                    }
                } catch (error) {
                    // Queue server might not be running or content not ready yet
                }
            }
            
            if (writingCards.length > 0) {
                renderBoard();
            }
        }

        function updateStats() {
            const total = allIdeas.length;
            const writing = allIdeas.filter(i => i.status === 'writing').length;
            const review = allIdeas.filter(i => i.status === 'review').length;
            
            document.getElementById('stats').textContent = 
                `${total} content ideas ‚Ä¢ ${writing} in progress ‚Ä¢ ${review} awaiting review`;
        }

        function openCard(id) {
            const idea = allIdeas.find(i => i.id === id);
            if (!idea) return;

            document.getElementById('modalTitle').innerHTML = `
                <span style="background:#2196f3;color:white;padding:6px 12px;border-radius:16px;font-size:14px;margin-right:12px;">#${idea.cardNumber}</span>
                ${idea.title}
            `;
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom:20px;padding:15px;background:#f5f5f5;border-radius:8px;">
                    <div class="detail-label">Move to Column</div>
                    <select id="statusSelect" onchange="changeCardStatus('${idea.id}')" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;background:white;cursor:pointer;margin-top:5px;">
                        <option value="ideas" ${idea.status === 'ideas' ? 'selected' : ''}>üí° IDEAS</option>
                        <option value="writing" ${idea.status === 'writing' ? 'selected' : ''}>‚úçÔ∏è WRITING</option>
                        <option value="review" ${idea.status === 'review' ? 'selected' : ''}>üëÄ REVIEW</option>
                        <option value="scheduled" ${idea.status === 'scheduled' ? 'selected' : ''}>üìÖ SCHEDULED</option>
                        <option value="published" ${idea.status === 'published' ? 'selected' : ''}>‚úÖ PUBLISHED</option>
                    </select>
                </div>
                
                ${idea.painPoint?.direct_quote ? `
                <div class="detail-section" style="background:#fff3cd;padding:12px;border-radius:8px;border-left:4px solid #ffc107;">
                    <div class="detail-label">üí¨ Customer Quote</div>
                    <div class="detail-value" style="font-style:italic;">"${idea.painPoint.direct_quote}"</div>
                </div>
                ` : ''}
                
                ${idea.painPoint?.description ? `
                <div class="detail-section" style="background:#ffebee;padding:12px;border-radius:8px;border-left:4px solid #f44336;">
                    <div class="detail-label">üò§ Pain Point ${idea.painPoint.severity ? `(${idea.painPoint.severity} severity)` : ''}</div>
                    <div class="detail-value">${idea.painPoint.description}</div>
                </div>
                ` : ''}
                
                ${idea.insight?.insight ? `
                <div class="detail-section" style="background:#e3f2fd;padding:12px;border-radius:8px;border-left:4px solid #2196f3;">
                    <div class="detail-label">üìä Business Insight ${idea.insight.impact ? `(${idea.insight.impact} impact)` : ''}</div>
                    <div class="detail-value">${idea.insight.insight}</div>
                </div>
                ` : ''}
                
                <div class="detail-section">
                    <div class="detail-label">üí° Content Angle</div>
                    <div class="detail-value">${idea.details.hook || idea.title}</div>
                </div>
                
                ${idea.details.topic_detail ? `
                <div class="detail-section">
                    <div class="detail-label">Topic Detail</div>
                    <div class="detail-value">${idea.details.topic_detail}</div>
                </div>
                ` : ''}
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;">
                    <div class="detail-section">
                        <div class="detail-label">Format</div>
                        <div class="detail-value">${idea.format.replace(/_/g, ' ')}</div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-label">Audience</div>
                        <div class="detail-value">${idea.audience.replace(/_/g, ' ')}</div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-label">Priority</div>
                        <div class="detail-value">${idea.priority}/10</div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">${idea.status.toUpperCase()}</div>
                    </div>
                    
                    ${idea.sentiment ? `
                    <div class="detail-section">
                        <div class="detail-label">Sentiment</div>
                        <div class="detail-value">${idea.sentiment}</div>
                    </div>
                    ` : ''}
                    
                    ${idea.outcome ? `
                    <div class="detail-section">
                        <div class="detail-label">Call Outcome</div>
                        <div class="detail-value">${idea.outcome.replace(/_/g, ' ')}</div>
                    </div>
                    ` : ''}
                </div>
                
                ${idea.generated_content ? `
                <div class="detail-section" style="margin-top:30px;padding-top:20px;border-top:2px solid #4caf50;">
                    <div class="detail-label" style="color:#4caf50;font-size:14px;">‚úÖ Generated Content</div>
                    <div class="detail-value" style="max-height:400px;overflow-y:auto;background:#f5f5f5;padding:15px;border-radius:8px;white-space:pre-wrap;line-height:1.8;font-size:13px;">${idea.generated_content}</div>
                </div>
                ` : ''}
            `;
            document.getElementById('modal').classList.add('active');
        }

        function changeCardStatus(cardId) {
            const newStatus = document.getElementById('statusSelect').value;
            const idea = allIdeas.find(i => i.id === cardId);
            
            if (idea) {
                idea.status = newStatus;
                localStorage.setItem(`card-status-${cardId}`, newStatus);
                
                // Notify backend if moved to "writing"
                if (newStatus === 'writing' && !idea.generated_content) {
                    notifyContentGeneration(idea);
                }
                
                closeModal();
                renderBoard();
                updateStats();
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        loadContentIdeas();
    </script>
</body>
</html>
